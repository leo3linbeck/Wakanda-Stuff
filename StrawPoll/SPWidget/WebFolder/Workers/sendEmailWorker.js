/*** @author Leo Linbeck III*/function addEmailRecord(personID, msgFrom, msgTo, msgSubject, msgBody) {	var u = ds.Person.find('ID = :1',personID);	if (u == null)		return ({			personID: personID,			votesCast: []		});	u.latestEmailAddress = msgFrom;	u.save();			var e = ds.Email.createEntity();	e.person = personID;	e.from = msgFrom;	e.to = msgTo;	e.subject = msgSubject;	e.body = msgBody;	e.sentOn = Date.now();	e.save();}onconnect = function sendEmail (event) {	debugger;	var r = [];	if (event.type == 'send') {		var mail = require("waf-mail/mail");				var mailbox = 'strawpollmailbox';		var password = 'j0hn.stu@rt.m1ll';		var mailHost = 'smtp.gmail.com';		var mailPort = 465;				var d = event.data;		if (separate) {			var toArray = d.msgTo.split(',');			for (var i = 0; i < toArray.length; i++) {				var msg = new mail.Mail(); 				msg.addField('From', d.msgFrom); 				msg.addField('To', toArray[i]); 				msg.addField('Subject', d.msgSubject);  				msg.setContent(d.msgBody);  				var result = msg.send(mailHost, mailPort, true, mailbox, password);				if (result)					addEmailRecord(personID, d.msgFrom, toArray[i], d.msgSubject, d.msgBody);				r.push(result);			}		}		else {			var msg = new mail.Mail(); 			msg.addField('From', d.msgFrom); 			msg.addField('To', d.msgTo); 			msg.addField('Subject', d.msgSubject);  			msg.setContent(d.msgBody);  			var result = msg.send(mailHost, mailPort, true, mailbox, password);			if (result)				addEmailRecord(personID, d.msgFrom, d.msgTo, d.msgSubject, d.msgBody);			r.push(result);		}		var thePort = event.ports[0];     		thePort.postMessage( {status: 'success', result: r } );	}	else {		var thePort = event.ports[0];     		thePort.postMessage( {status: 'fail', result: [] } );	}}